function Constructor(b,a){new TableLoader(b,a,function(){new TableEditor(b,(new CsvExtractor(b)).extract);new TableFilterer(b)})}function explain(b){"undefined"!=typeof console&&console.log(b)}if("undefined"===typeof jQuery)throw"JQuery could not be found, and is required by CSVera";if("undefined"===typeof _)throw"Underscore.js could not be found, and is required by CSVera";$(document).ready(function(){$("table[csv]").each(function(){new Constructor($(this).attr("id"),$(this).attr("csv"))})});function CsvExtractor(b){var a="#"+b;this.extract=function(){return $(a).find("tr").map(function(){return $(this).children("td").map(function(){return $(this).text()}).get().join(",")}).get().join("\n")}};function InlineCellEditor(){function b(a){var c;a.dblclick(function(){c=a.text();a.html("<input type='text' class='inCellAdams' value='"+c+"'/>");var b=a.find("input");b.offset(a.position()).height(a.outerHeight()).width(a.outerWidth()).blur(function(){a.html(b.val())}).click(function(a){a.stopPropagation()}).focus()})}this.prime=function(a){a.children("td").each(function(){new b($(this))})};explain("Double-click a table cell     Edit cell contents")};function AddRow(b){this.processKeypress=function(a,c){if((c.metaKey||c.ctrlKey)&&68==c.which){var e=a.clone();a.after(e);b(e);c.preventDefault();return!0}return!1};explain("CTRL-d                        Duplicate currently-selected row")}
function MoveRow(){function b(a,c){"none"===a.css("display")?b(a.prev(),c):"none"===c.css("display")?b(a,c.next()):a.before(c)}this.processKeypress=function(a,c){switch(c.which){case 38:b(a.prev(),a);break;case 40:b(a,a.next())}return 38==c.which||40==c.which};explain("Up and down arrow keys        Move currently-selected row")}
function CtrlCmd(b){this.processKeypress=function(a,c){(c.metaKey||c.ctrlKey)&&65==c.which&&b();return!1};explain("CTRL-a                        Enter RAW MODE, displaying raw CSV");explain("CTRL-C                        RAW MODE: copy, of course");explain("ESC                           RAW MODE: exit raw mode")};function RawEditor(b){b.addClass("max");var a=b.offset();b.offset({top:0,left:0});b.keydown(function(c){if(c.metaKey&&67==c.which||27==c.which)b.removeClass("max"),b.offset(a)})};function selectText(b){var a=document;if(a.body.createTextRange)a=a.body.createTextRange(),a.moveToElementText(b),a.select();else if(window.getSelection){var c=window.getSelection(),a=a.createRange();a.selectNodeContents(b);c.removeAllRanges();c.addRange(a)}};function TableEditor(b,a){function c(a,b){var c=$(b);k.prime(c);c.click(function(){e();g=c;c.addClass("selected");f()})}function e(){g&&g.removeClass("selected")}function f(){$(h).offset({top:g.position().top,left:-10});$(h).focus()}explain("Click a row                   Select the row");var d="#"+b,h="#focusableField",g,j=[new AddRow(function(a){c(0,a.get(0))}),new MoveRow,new CtrlCmd(function(){$(h).text(a());new RawEditor($(h),f)})],k=new InlineCellEditor;$(d).after("<textarea id='focusableField' type='text' class='littleFloater' name='whatever' value='whatever'/>");
$(d).find("tbody tr").each(c);$(h).keydown(function(a){var c=!1;j.forEach(function(b){b.processKeypress(g,a)&&(c=!0)});c&&f()}).blur(e);$(d).find("tbody tr").first().click();explain("Mac users                     Use CMD in place of CTRL")};function TableFilterer(b){function a(a,b){function d(){a.on("click.ColumnFilterer",h)}function h(){a.off("click.ColumnFilterer");a.append("<select name='"+l+"' class='filterSelect'>"+k()+"</select>");var b=a.find("select");b.change(g).blur(j).attr("size",b.find("option").size()).focus()}function g(){var d=$(this).val().trim();$(c).find("tbody tr").each(function(){$($(this).children("td").get(b)).text().trim()===d?$(this).show():$(this).hide()});$(c).find("thead .filtered").each(function(){$(this).removeClass("filtered")});
j();a.addClass("filtered")}function j(){a.html(l);d()}function k(){var a=_.uniq($(c).find("tr").map(function(){return $($(this).children("td").get(b)).text()}).get());return _.map(a,m).join("")}function m(a){return"<option value='"+a+"'>"+a+"</option>"}var l=a.html();d()}var c="#"+b;$(c).find("thead td").each(function(b){new a($(this),b)})};function TableLoader(b,a,c){function e(a){return"<tr>"+a.split(",",7).map(function(a){return"<td>"+a+"</td>"}).join("\n")+" </tr>"}var f="#"+b;$(this).inc(a,function(a){a=a.split("\n");$(f).append("<thead>"+e(a.shift())+"</thead>");$(f).append("<tbody>"+a.map(e).join("\n")+"</tbody>")},c)};jQuery.fn.inc=function(b,a,c,e,f,d){return this.length?this.each(function(){e=$(this);d=function(b){e.html($.isFunction(a)?a(b):b);c&&c()};$.browser.msie?$("<iframe>").hide().bind("readystatechange",function(){/m/.test(this.readyState)&&(d(this.contentWindow.document.body.innerHTML),$(this).remove())}).attr("src",b).appendTo(document.body):$.ajax({url:b,complete:function(a,b){/c/.test(b)&&d(a.responseText)}})}):this};
$(function(){$('[class*="inc"]').each(function(){$(this).inc(unescape(this.className.replace(/.*inc:([^ $]+)/,"$1")))})});
