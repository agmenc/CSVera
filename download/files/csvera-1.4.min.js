function Constructor(b,a){new TableLoader(b,a,function(){new TableEditor(b,(new CsvExtractor(b)).extract);new TableFilterer(b)})}function explain(b){"undefined"!=typeof console&&console.log(b)}if("undefined"===typeof jQuery)throw"JQuery could not be found, and is required by CSVera";if("undefined"===typeof _)throw"Underscore.js could not be found, and is required by CSVera";$(document).ready(function(){$("table[csv]").each(function(){new Constructor($(this).attr("id"),$(this).attr("csv"))})});function CsvExtractor(b){var a="#"+b;this.extract=function(){return $(a).find("tr").map(function(){return $(this).children("td").map(function(){return $(this).text()}).get().join(",")}).get().join("\n")}};function InlineCellEditor(){function b(a){var b;a.dblclick(function(){b=a.text();a.html("<input type='text' class='inCellAdams' value='"+b+"'/>");var d=a.find("input");d.offset(a.position()).height(a.outerHeight()).width(a.outerWidth()).blur(function(){a.html(d.val())}).click(function(a){a.stopPropagation()}).focus()})}this.prime=function(a){a.children("td").each(function(){new b($(this))})};explain("Double-click a table cell     Edit cell contents")};function AddRow(b){this.processKeypress=function(a,c){if(c.metaKey&&68==c.which){var d=a.clone();a.after(d);b(d);c.preventDefault();return!0}return!1};explain("CTRL-d                        Duplicate currently-selected row")}
function MoveRow(){function b(a,c){"none"===a.css("display")?b(a.prev(),c):"none"===c.css("display")?b(a,c.next()):a.before(c)}this.processKeypress=function(a,c){switch(c.which){case 38:b(a.prev(),a);break;case 40:b(a,a.next())}return 38==c.which||40==c.which};explain("Up and down arrow keys        Move currently-selected row")}
function CtrlCmd(b){this.processKeypress=function(a,c){c.metaKey&&65==c.which&&b();return!1};explain("CTRL-a                        Enter RAW MODE, displaying raw CSV");explain("CTRL-C                        RAW MODE: copy, of course");explain("ESC                           RAW MODE: exit raw mode")};function RawEditor(b){b.addClass("max");var a=b.offset();b.offset({top:0,left:0});b.keydown(function(c){if(c.metaKey&&67==c.which||27==c.which)b.removeClass("max"),b.offset(a)})};function selectText(b){var a=document;if(a.body.createTextRange)a=a.body.createTextRange(),a.moveToElementText(b),a.select();else if(window.getSelection){var c=window.getSelection(),a=a.createRange();a.selectNodeContents(b);c.removeAllRanges();c.addRange(a)}};function TableEditor(b,a){function c(a,b){var c=$(b);k.prime(c);c.click(function(){d();f=c;c.addClass("selected");h()})}function d(){f&&f.removeClass("selected")}function h(){$(g).offset({top:f.position().top,left:-10});$(g).focus()}explain("Click a row                   Select the row");var e="#"+b,g="#focusableField",f,j=[new AddRow(function(a){c(0,a.get(0))}),new MoveRow,new CtrlCmd(function(){$(g).text(a());new RawEditor($(g))})],k=new InlineCellEditor;$(e).after("<textarea id='focusableField' type='text' class='littleFloater' name='whatever' value='whatever'/>");
$(e).find("tbody tr").each(c);$(g).keydown(function(a){var b=!1;j.forEach(function(c){c.processKeypress(f,a)&&(b=!0)});b&&h()}).blur(d);$(e).find("tbody tr").first().click();explain("Mac users                     Use CMD in place of CTRL")};function TableFilterer(b){function a(a,b){function e(){a.on("click.ColumnFilterer",g)}function g(){a.off("click.ColumnFilterer");a.append("<select name='"+l+"' class='filterSelect'>"+k()+"</select>");var b=a.find("select");b.change(f).blur(j).attr("size",b.find("option").size()).focus()}function f(){var e=$(this).val().trim();$(c).find("tbody tr").each(function(){$($(this).children("td").get(b)).text().trim()===e?$(this).show():$(this).hide()});$(c).find("thead .filtered").each(function(){$(this).removeClass("filtered")});
j();a.addClass("filtered")}function j(){a.html(l);e()}function k(){var a=_.uniq($(c).find("tr").map(function(){return $($(this).children("td").get(b)).text()}).get());return _.map(a,m).join("")}function m(a){return"<option value='"+a+"'>"+a+"</option>"}var l=a.html();e()}var c="#"+b;$(c).find("thead td").each(function(b){new a($(this),b)})};function TableLoader(b,a,c){function d(a){return"<tr>"+a.split(",",7).map(function(a){return"<td>"+a+"</td>"}).join("\n")+" </tr>"}var h="#"+b;$(this).inc(a,function(a){a=a.split("\n");$(h).append("<thead>"+d(a.shift())+"</thead>");$(h).append("<tbody>"+a.map(d).join("\n")+"</tbody>")},c)};jQuery.fn.inc=function(b,a,c,d,h,e){return this.length?this.each(function(){d=$(this);e=function(b){d.html($.isFunction(a)?a(b):b);c&&c()};$.browser.msie?$("<iframe>").hide().bind("readystatechange",function(){/m/.test(this.readyState)&&(e(this.contentWindow.document.body.innerHTML),$(this).remove())}).attr("src",b).appendTo(document.body):$.ajax({url:b,complete:function(a,b){/c/.test(b)&&e(a.responseText)}})}):this};
$(function(){$('[class*="inc"]').each(function(){$(this).inc(unescape(this.className.replace(/.*inc:([^ $]+)/,"$1")))})});
