function Constructor(b,a){new TableLoader(b,a,function(){new TableEditor(b,(new CsvExtractor(b)).extract);new TableFilterer(b)})}function explain(b){"undefined"!=typeof console&&console.log(b)}if("undefined"===typeof jQuery)throw"JQuery could not be found, and is required by CSVera";if("undefined"===typeof _)throw"Underscore.js could not be found, and is required by CSVera";$(document).ready(function(){$("table[csv]").each(function(){new Constructor($(this).attr("id"),$(this).attr("csv"))});new ControlPanel($("table[csv]"))});function ControlPanel(b){if(1<b.size()){$("body").append("<div id='csveraControlPanel' style='display: none;'></div>");var a=$("#csveraControlPanel");b.each(function(){var c=$(this);a.append("<button id='button_"+c.attr("id")+"'>"+c.attr("id")+"</button>");$("#button_"+c.attr("id")).click(function(){b.hide();c.show()})});b.first().before(a);a.show();if(param("table")){var c=$("#"+param("table"));$("#button_"+c.attr("id")).click()}}};function CsvExtractor(b){var a="#"+b;this.extract=function(){return $(a).find("tr").map(function(){return $(this).children("td").map(function(){return $(this).text()}).get().join(",")}).get().join("\n")}};function InlineCellEditor(){function b(a){var b;a.dblclick(function(){b=a.text();a.html("<input type='text' class='inCellAdams' value='"+b+"'/>");var d=a.find("input");d.offset(a.position()).height(a.outerHeight()).width(a.outerWidth()).blur(function(){a.html(d.val())}).click(function(a){a.stopPropagation()}).focus()})}this.prime=function(a){a.children("td").each(function(){new b($(this))})};explain("Double-click a table cell     Edit cell contents")};function keyFor(b){return new KeyEvent(b)}function KeyEvent(b){this.CTRL=function(a){var c;if(c=b.metaKey||b.ctrlKey){c=b.which;a:switch(a){case "a":a=65;break a;case "c":a=67;break a;case "d":a=68;break a;default:throw"Unsupported character: "+a+". Please find an automagic way of mapping from chars to ASCII code.";}c=c==a}return c};this.ESC=function(){return 27==b.which};this.upArrow=function(){return 38==b.which};this.downArrow=function(){return 40==b.which}}
function AddRow(b){this.processKeypress=function(a,c){if(keyFor(c).CTRL("d")){var d=a.clone();a.after(d);b(d);c.preventDefault();return!0}return!1};explain("CTRL-d                        Duplicate currently-selected row")}
function MoveRow(){function b(a,c){"none"===a.css("display")?b(a.prev(),c):"none"===c.css("display")?b(a,c.next()):a.before(c);return!0}this.processKeypress=function(a,c){return keyFor(c).upArrow()?b(a.prev(),a):keyFor(c).downArrow()?b(a,a.next()):!1};explain("Up and down arrow keys        Move currently-selected row")}
function CtrlCmd(b){this.processKeypress=function(a,c){keyFor(c).CTRL("a")&&b();return!1};explain("CTRL-a                        Enter RAW MODE, displaying raw CSV");explain("CTRL-C                        RAW MODE: copy, of course");explain("ESC                           RAW MODE: exit raw mode")};function param(b){var a=void 0;document.location.href.split(/\?|&/).splice(1).forEach(function(c){c=c.split("=");c[0]===b&&(a=c[1])});return a};function RawEditor(b){b.addClass("max");var a=b.offset();b.offset({top:0,left:0});b.keydown(function(c){c=keyFor(c);if(c.CTRL("c")||c.ESC())b.removeClass("max"),b.offset(a),setTimeout(function(){b.text("")},500)})};function selectText(b){var a=document;if(a.body.createTextRange)a=a.body.createTextRange(),a.moveToElementText(b),a.select();else if(window.getSelection){var c=window.getSelection(),a=a.createRange();a.selectNodeContents(b);c.removeAllRanges();c.addRange(a)}};function TableEditor(b,a){function c(a,b){var c=$(b);k.prime(c);c.click(function(){d();f=c;c.addClass("selected");h()})}function d(){f&&f.removeClass("selected")}function h(){$(g).offset({top:f.position().top,left:-10});$(g).focus()}explain("Click a row                   Select the row");var e="#"+b,g="#focusableField_"+b,f,l=[new AddRow(function(a){c(0,a.get(0))}),new MoveRow,new CtrlCmd(function(){$(g).text(a());new RawEditor($(g))})],k=new InlineCellEditor;$(e).after("<textarea id='focusableField_"+
b+"' type='text' class='littleFloater' name='whatever' value='whatever'/>");$(e).find("tbody tr").each(c);$(g).keydown(function(a){var b=!1;l.forEach(function(c){c.processKeypress(f,a)&&(b=!0)});b&&h()}).blur(d);$(e).find("tbody tr").first().click();explain("Mac users                     Use CMD in place of CTRL")};function TableFilterer(b){function a(a,b){function e(){a.on("click.ColumnFilterer",g)}function g(){a.off("click.ColumnFilterer");a.append("<select name='"+j+"' class='filterSelect'>"+m()+"</select>");var b=a.find("select");b.change(f).blur(l).attr("size",b.find("option").size()).focus()}function f(){$(c).find("thead .filtered").each(function(){$(this).removeClass("filtered")});k($(this).val().trim());l()}function l(){a.html(j);e()}function k(e){$(c).find("tbody tr").each(function(){$($(this).children("td").get(b)).text().trim()===
e?$(this).show():$(this).hide()});a.addClass("filtered")}function m(){var a=_.uniq($(c).find("tr").map(function(){return $($(this).children("td").get(b)).text()}).get());return _.map(a,n).join("")}function n(a){return"<option value='"+a+"'>"+a+"</option>"}var j=a.html();e();param(j.trim())&&k(param(j.trim()))}var c="#"+b;$(c).find("thead td").each(function(b){new a($(this),b)})};function TableLoader(b,a,c){function d(a){return"<tr>"+a.split(",",-1).map(function(a){return"<td>"+a+"</td>"}).join("\n")+" </tr>"}var h="#"+b;$(this).inc(a,function(a){a=a.split("\n");$(h).append("<thead>"+d(a.shift())+"</thead>");$(h).append("<tbody>"+a.map(d).join("\n")+"</tbody>")},c)};jQuery.fn.inc=function(b,a,c,d,h,e){return this.length?this.each(function(){d=$(this);e=function(b){d.html($.isFunction(a)?a(b):b);c&&c()};$.browser.msie?$("<iframe>").hide().bind("readystatechange",function(){/m/.test(this.readyState)&&(e(this.contentWindow.document.body.innerHTML),$(this).remove())}).attr("src",b).appendTo(document.body):$.ajax({url:b,complete:function(a,b){/c/.test(b)&&e(a.responseText)}})}):this};
$(function(){$('[class*="inc"]').each(function(){$(this).inc(unescape(this.className.replace(/.*inc:([^ $]+)/,"$1")))})});
