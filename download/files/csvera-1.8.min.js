function Constructor(a,b){new TableLoader(a,b,function(){new TableEditor(a,(new CsvExtractor(a)).extract);new TableFilterer(a)})}if("undefined"===typeof jQuery)throw"JQuery could not be found, and is required by CSVera";if("undefined"===typeof _)throw"Underscore.js could not be found, and is required by CSVera";
$(document).ready(function(){function a(b){"undefined"!=typeof console&&console.log(b)}$("table[csv]").each(function(){new Constructor($(this).attr("id"),$(this).attr("csv"))});new ControlPanel($("table[csv]"));a("Click a row                   Select the row");a("Up and down arrow keys        Move currently-selected row");a("Mac users                     Use CMD in place of CTRL");a("CTRL-d                        Duplicate currently-selected row");a("Double-click a table cell     Edit cell contents");
a("CTRL-a                        Enter RAW MODE, displaying raw CSV");a("CTRL-C                        RAW MODE: copy, of course");a("ESC                           RAW MODE: exit raw mode")});function ControlPanel(a){if(1<a.size()){$("body").append("<div id='csveraControlPanel' style='display: none;'></div>");var b=$("#csveraControlPanel");a.each(function(){var c=$(this);b.append("<button id='button_"+c.attr("id")+"'>"+c.attr("id")+"</button>");$("#button_"+c.attr("id")).click(function(){a.hide();c.show();b.find("button").css("font-weight","normal");$(this).css("font-weight","bold");param("table",c.attr("id"))})});a.first().before(b);b.show();if(param("table")){var c=$("#"+param("table"));
$("#button_"+c.attr("id")).click()}else $("#csveraControlPanel").find("button").first().click()}};function CsvExtractor(a){var b="#"+a;this.extract=function(){return $(b).find("tr").map(function(){return $(this).children("td").map(function(){return $(this).text()}).get().join(",")}).get().join("\n")}};function InlineCellEditor(){function a(b){var a;b.dblclick(function(){a=b.text();b.html("<input type='text' class='inCellAdams' value='"+a+"'/>");var d=b.find("input");d.offset(b.position()).height(b.outerHeight()).width(b.outerWidth()).blur(function(){b.html(d.val())}).click(function(a){a.stopPropagation()}).focus()})}this.prime=function(b){b.children("td").each(function(){new a($(this))})}};function keyFor(a){return new KeyEvent(a)}function KeyEvent(a){this.CTRL=function(b){var c;if(c=a.metaKey||a.ctrlKey){c=a.which;a:switch(b){case "a":b=65;break a;case "c":b=67;break a;case "d":b=68;break a;default:throw"Unsupported character: "+b+". Please find an automagic way of mapping from chars to ASCII code.";}c=c==b}return c};this.ESC=function(){return 27==a.which};this.upArrow=function(){return 38==a.which};this.downArrow=function(){return 40==a.which}}
function AddRow(a){this.processKeypress=function(b,c){if(keyFor(c).CTRL("d")){var d=b.clone();b.after(d);a(d);c.preventDefault();return!0}return!1}}function MoveRow(){function a(b,c){"none"===b.css("display")?a(b.prev(),c):"none"===c.css("display")?a(b,c.next()):b.before(c);return!0}this.processKeypress=function(b,c){return keyFor(c).upArrow()?a(b.prev(),b):keyFor(c).downArrow()?a(b,b.next()):!1}}function CtrlCmd(a){this.processKeypress=function(b,c){keyFor(c).CTRL("a")&&a();return!1}};var paramParser;
function param(a,b){function c(){paramParser.href=document.location.href;var a={};paramParser.search.split(/\?|&/).splice(1).forEach(function(b){b=b.split("=");a[b[0]]=b[1]});return a}"undefined"===typeof paramParser&&(paramParser=document.createElement("a"),$(paramParser).hide());if("undefined"===typeof b)return c()[a.trim()];(function(a,b){var e=c();if("Show All"===b){var j={},f;for(f in e)f!=a&&(j[f]=e[f]);e=j}else e[a]=b;f=e;var e=[],h;for(h in f)f.hasOwnProperty(h)&&""!=h.trim()&&e.push(h+"="+
f[h]);h=0<e.length?"?"+e.join("&"):_.last(paramParser.pathname.split(/\//));history.replaceState({path:this.path},"",h)})(a.trim(),b)};function RawEditor(a){a.addClass("max");var b=a.offset();a.offset({top:$("body").scrollTop(),left:0});a.keydown(function(c){c=keyFor(c);if(c.CTRL("c")||c.ESC())a.removeClass("max"),a.offset(b),setTimeout(function(){a.text("")},500)})};function selectText(a){var b=document;if(b.body.createTextRange)b=b.body.createTextRange(),b.moveToElementText(a),b.select();else if(window.getSelection){var c=window.getSelection(),b=b.createRange();b.selectNodeContents(a);c.removeAllRanges();c.addRange(b)}};function TableEditor(a,b){function c(a,b){var c=$(b);l.prime(c);c.click(function(){d();f=c;c.addClass("selected");g()})}function d(){f&&f.removeClass("selected")}function g(){$(j).offset({top:f.position().top,left:-10});$(j).focus()}var e="#"+a,j="#focusableField_"+a,f,h=[new AddRow(function(a){c(0,a.get(0))}),new MoveRow,new CtrlCmd(function(){$(j).text(b());new RawEditor($(j))})],l=new InlineCellEditor;$(e).after("<textarea id='focusableField_"+a+"' type='text' class='littleFloater' name='whatever' value='whatever'/>");
$(e).find("tbody tr").each(c);$(j).keydown(function(a){var b=!1;h.forEach(function(c){c.processKeypress(f,a)&&(b=!0)});b&&g()}).blur(d);$(e).find("tbody tr").first().click()};function TableFilterer(a){function b(){$(d).find("tbody tr").each(function(){var a=$(this);_.reduce(g,function(b,c){return b&&c.accept(a)},!0)?$(this).show():$(this).hide()})}function c(a,c){function f(){a.on("click.ColumnFilterer",h)}function h(){a.off("click.ColumnFilterer");a.append("<select name='"+k+"' class='filterSelect'>"+r()+"</select>");var b=a.find("select");b.change(l).blur(n).attr("size",b.find("option").size()).focus()}function l(){var c=$(this).val().trim();"Show All"===c?(g=_.without(g,
m),b(),a.removeClass("filtered"),param(k,"Show All")):p(c);n()}function n(){a.html(k);f()}function p(c){q=c;g.push(m);b();a.addClass("filtered");param(k,c)}function r(){var a=_.uniq($(d).find("tr").map(function(){return $($(this).children("td").get(c)).text()}).get());a.splice(1,0,"Show All");return _.map(a,s).join("")}function s(a){return"<option value='"+a+"'>"+a+"</option>"}var m=this,k=a.html(),q="";m.accept=function(a){return $(a.children("td").get(c)).text().trim()===q};f();param(k)&&p(param(k))}
var d="#"+a,g=[];$(d).find("thead td").each(function(a){new c($(this),a)})};function TableLoader(a,b,c){function d(a){return"<tr>"+a.split(",",-1).map(function(a){return"<td>"+a+"</td>"}).join("\n")+" </tr>"}var g="#"+a;$(this).inc(b,function(a){a=a.split("\n");$(g).append("<thead>"+d(a.shift())+"</thead>");$(g).append("<tbody>"+a.map(d).join("\n")+"</tbody>")},c)};jQuery.fn.inc=function(a,b,c,d,g,e){return this.length?this.each(function(){d=$(this);e=function(a){d.html($.isFunction(b)?b(a):a);c&&c()};$.browser.msie?$("<iframe>").hide().bind("readystatechange",function(){/m/.test(this.readyState)&&(e(this.contentWindow.document.body.innerHTML),$(this).remove())}).attr("src",a).appendTo(document.body):$.ajax({url:a,complete:function(a,b){/c/.test(b)&&e(a.responseText)}})}):this};
$(function(){$('[class*="inc"]').each(function(){$(this).inc(unescape(this.className.replace(/.*inc:([^ $]+)/,"$1")))})});
